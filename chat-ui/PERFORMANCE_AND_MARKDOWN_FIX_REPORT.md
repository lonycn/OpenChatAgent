# æ€§èƒ½ä¼˜åŒ–å’ŒMarkdownæ”¯æŒä¿®å¤æŠ¥å‘Š

## ğŸš¨ é—®é¢˜ç°è±¡

1. **å¡é¡¿é—®é¢˜**ï¼šWebSocketæ¢å¤é¢‘ç‡å¾ˆé«˜ï¼Œä½†bubbleé—´éš”å¾ˆä¹…æ‰æ›´æ–°ä¸€æ¬¡ï¼Œçœ‹èµ·æ¥å¡é¡¿
2. **æ¶ˆæ¯ä¸¢å¤±**ï¼šConsoleæ˜¾ç¤ºæ˜æ˜¾æ²¡æœ‰å…¨éƒ¨WebSocketæœ€æ–°æ¶ˆæ¯ï¼Œéƒ¨åˆ†æ¶ˆæ¯è¢«è¿‡æ»¤
3. **Markdownä¸æ”¯æŒ**ï¼šå›å¤å†…å®¹ä¸­çš„Markdownæ ¼å¼æ²¡æœ‰æ­£ç¡®è§£é‡Š

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. é‡å¤æ¶ˆæ¯è¿‡æ»¤æœºåˆ¶è¿‡äºä¸¥æ ¼

**åŸå§‹é€»è¾‘é—®é¢˜**ï¼š

```javascript
// é—®é¢˜ï¼šä½¿ç”¨timestampä½œä¸ºkeyçš„ä¸€éƒ¨åˆ†
const messageKey = `${data.type}_${data.id || Date.now()}_${data.timestamp || ""}`;
```

**é—®é¢˜**ï¼š

- æµå¼æ¶ˆæ¯çš„æ¯ä¸ªç‰‡æ®µéƒ½æœ‰ä¸åŒçš„timestamp
- å¯¼è‡´å¤§é‡æœ‰æ•ˆçš„æµå¼æ›´æ–°è¢«é”™è¯¯åœ°æ ‡è®°ä¸º"é‡å¤æ¶ˆæ¯"
- é€ æˆæ¶ˆæ¯ä¸¢å¤±å’Œç•Œé¢å¡é¡¿

### 2. ç¼“å­˜æ— é™å¢é•¿

**é—®é¢˜**ï¼š

- `processedMessageIds` Setæ— é™å¢é•¿ï¼Œæ²¡æœ‰æ¸…ç†æœºåˆ¶
- å†…å­˜æ³„æ¼é£é™©
- æŸ¥æ‰¾æ€§èƒ½é€æ¸ä¸‹é™

### 3. ç¼ºå°‘Markdownæ”¯æŒ

**é—®é¢˜**ï¼š

- æ‰€æœ‰æ¶ˆæ¯éƒ½ä»¥çº¯æ–‡æœ¬æ˜¾ç¤º
- ä»£ç å—ã€åˆ—è¡¨ã€é“¾æ¥ç­‰æ ¼å¼æ— æ³•æ­£ç¡®æ¸²æŸ“
- ç”¨æˆ·ä½“éªŒå·®

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ä¼˜åŒ–é‡å¤æ¶ˆæ¯è¿‡æ»¤æœºåˆ¶

**ä¿®å¤å‰**ï¼š

```javascript
const messageKey = `${data.type}_${data.id || Date.now()}_${data.timestamp || ""}`;
```

**ä¿®å¤å**ï¼š

```javascript
if (data.type === "stream" || data.type === "streaming") {
  // æµå¼æ¶ˆæ¯ï¼šä½¿ç”¨ID+æ–‡æœ¬é•¿åº¦ï¼Œå…è®¸å†…å®¹æ›´æ–°
  const textLength = (data.fullText || data.text || "").length;
  messageKey = `${data.type}_${data.id}_${textLength}`;

  // æ¸…ç†æ—§çš„æµå¼æ¶ˆæ¯ç¼“å­˜ï¼Œåªä¿ç•™æœ€æ–°çš„
  const streamPrefix = `${data.type}_${data.id}_`;
  const keysToDelete = Array.from(processedMessageIds.current).filter(
    (key) => key.startsWith(streamPrefix) && key !== messageKey
  );
  keysToDelete.forEach((key) => processedMessageIds.current.delete(key));
} else {
  // å…¶ä»–æ¶ˆæ¯ä½¿ç”¨å®Œæ•´key
  messageKey = `${data.type}_${data.id || Date.now()}_${data.timestamp || ""}`;
}
```

### 2. æ·»åŠ ç¼“å­˜æ¸…ç†æœºåˆ¶

```javascript
// å®šæœŸæ¸…ç†ç¼“å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼
if (processedMessageIds.current.size > 1000) {
  const keysArray = Array.from(processedMessageIds.current);
  const keysToKeep = keysArray.slice(-500); // åªä¿ç•™æœ€è¿‘500æ¡
  processedMessageIds.current.clear();
  keysToKeep.forEach((key) => processedMessageIds.current.add(key));
}
```

### 3. é›†æˆMarkdownæ”¯æŒ

**å®‰è£…ä¾èµ–**ï¼š

```bash
npm install react-markdown remark-gfm
```

**å®ç°Markdownæ¸²æŸ“**ï¼š

```javascript
// æ™®é€šæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“
return (
  <Bubble
    content={
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        components={{
          // è‡ªå®šä¹‰æ ·å¼
          p: ({ children }) => (
            <p style={{ margin: "0.5em 0", lineHeight: "1.6" }}>{children}</p>
          ),
          code: ({ children }) => (
            <code
              style={{
                backgroundColor: "#f5f5f5",
                padding: "2px 4px",
                borderRadius: "3px",
                fontFamily: "Monaco, Consolas, monospace",
                fontSize: "0.9em",
              }}
            >
              {children}
            </code>
          ),
          pre: ({ children }) => (
            <pre
              style={{
                backgroundColor: "#f5f5f5",
                padding: "12px",
                borderRadius: "6px",
                overflow: "auto",
              }}
            >
              {children}
            </pre>
          ),
          // ... æ›´å¤šæ ·å¼
        }}
      >
        {content.text}
      </ReactMarkdown>
    }
  />
);
```

### 4. ä¼˜åŒ–æµå¼æ˜¾ç¤ºæ€§èƒ½

**æé«˜æ‰“å­—æœºé€Ÿåº¦**ï¼š

```javascript
<StreamingText
  value={content.text}
  speed={15} // ä»30msé™ä½åˆ°15msï¼Œå‡å°‘å¡é¡¿æ„Ÿ
  onComplete={() => {
    console.log("âœ… æµå¼æ¶ˆæ¯æ˜¾ç¤ºå®Œæˆ");
  }}
/>
```

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ æµå¼æ¶ˆæ¯å¡é¡¿ï¼Œæ›´æ–°ä¸æµç•…
- âŒ å¤§é‡æ¶ˆæ¯è¢«é”™è¯¯è¿‡æ»¤
- âŒ Consoleæ˜¾ç¤ºä¸å®Œæ•´
- âŒ Markdownæ ¼å¼ä¸æ”¯æŒ
- âŒ å†…å­˜å¯èƒ½æ³„æ¼

### ä¿®å¤å

- âœ… **æµå¼æ¶ˆæ¯æµç•…æ›´æ–°**
- âœ… **æ‰€æœ‰æœ‰æ•ˆæ¶ˆæ¯éƒ½è¢«å¤„ç†**
- âœ… **Consoleæ˜¾ç¤ºå®Œæ•´çš„æ¶ˆæ¯æµ**
- âœ… **å®Œæ•´çš„Markdownæ”¯æŒ**
- âœ… **è‡ªåŠ¨ç¼“å­˜æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼**
- âœ… **æ›´å¿«çš„æ‰“å­—æœºæ•ˆæœ**

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ¶ˆæ¯å¤„ç†æµç¨‹ä¼˜åŒ–

```
WebSocketæ¶ˆæ¯åˆ°è¾¾
    â†“
æ™ºèƒ½å»é‡æ£€æŸ¥ï¼ˆæµå¼æ¶ˆæ¯ç‰¹æ®Šå¤„ç†ï¼‰
    â†“
æ¸…ç†æ—§çš„æµå¼æ¶ˆæ¯ç¼“å­˜
    â†“
å¤„ç†æ¶ˆæ¯å†…å®¹
    â†“
æµå¼æ¶ˆæ¯ï¼šStreamingTextç»„ä»¶
æ™®é€šæ¶ˆæ¯ï¼šReactMarkdownç»„ä»¶
    â†“
æµç•…çš„ç•Œé¢æ›´æ–°
```

### MarkdownåŠŸèƒ½æ”¯æŒ

- **åŸºç¡€æ ¼å¼**ï¼šç²—ä½“ã€æ–œä½“ã€åˆ é™¤çº¿
- **ä»£ç å—**ï¼šè¡Œå†…ä»£ç å’Œä»£ç å—ï¼Œå¸¦è¯­æ³•é«˜äº®æ ·å¼
- **åˆ—è¡¨**ï¼šæœ‰åºåˆ—è¡¨å’Œæ— åºåˆ—è¡¨
- **å¼•ç”¨**ï¼šå—å¼•ç”¨æ ·å¼
- **é“¾æ¥**ï¼šè‡ªåŠ¨é“¾æ¥è¯†åˆ«
- **è¡¨æ ¼**ï¼šGitHubé£æ ¼è¡¨æ ¼ï¼ˆé€šè¿‡remark-gfmï¼‰
- **ä»»åŠ¡åˆ—è¡¨**ï¼šå¤é€‰æ¡†åˆ—è¡¨

### æ€§èƒ½ä¼˜åŒ–

1. **æ™ºèƒ½å»é‡**ï¼š

   - æµå¼æ¶ˆæ¯åªæ¯”è¾ƒæ–‡æœ¬é•¿åº¦å˜åŒ–
   - è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ç¼“å­˜key
   - é¿å…è¯¯åˆ¤é‡å¤æ¶ˆæ¯

2. **å†…å­˜ç®¡ç†**ï¼š

   - ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆ1000æ¡ï¼‰
   - è‡ªåŠ¨æ¸…ç†æœºåˆ¶ï¼ˆä¿ç•™æœ€è¿‘500æ¡ï¼‰
   - é˜²æ­¢å†…å­˜æ³„æ¼

3. **æ¸²æŸ“ä¼˜åŒ–**ï¼š
   - æ›´å¿«çš„æ‰“å­—æœºé€Ÿåº¦ï¼ˆ15msï¼‰
   - å‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
   - ä¼˜åŒ–ç»„ä»¶æ›´æ–°é¢‘ç‡

## ğŸ¯ éªŒè¯æ–¹æ³•

1. **æµç•…åº¦æµ‹è¯•**ï¼š

   - å‘é€æ¶ˆæ¯ï¼Œè§‚å¯Ÿæµå¼å›å¤æ˜¯å¦æµç•…
   - æ£€æŸ¥Consoleæ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰WebSocketæ¶ˆæ¯
   - ç¡®è®¤æ²¡æœ‰"Skipping duplicate message"çš„è¯¯æŠ¥

2. **Markdownæµ‹è¯•**ï¼š

   - æµ‹è¯•ä»£ç å—ï¼š\`\`\`javascript\ncode\n\`\`\`
   - æµ‹è¯•åˆ—è¡¨ï¼š- item1\n- item2
   - æµ‹è¯•ç²—ä½“ï¼š**bold text**
   - æµ‹è¯•é“¾æ¥ï¼š[link](url)

3. **æ€§èƒ½æµ‹è¯•**ï¼š
   - é•¿æ—¶é—´ä½¿ç”¨ï¼Œè§‚å¯Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ
   - å¤šè½®å¯¹è¯ï¼Œç¡®è®¤ç¼“å­˜æ­£å¸¸æ¸…ç†

## ğŸ“‹ æ”¯æŒçš„Markdownè¯­æ³•

- **æ–‡æœ¬æ ¼å¼**ï¼š_æ–œä½“_ã€**ç²—ä½“**ã€~~åˆ é™¤çº¿~~
- **ä»£ç **ï¼š\`è¡Œå†…ä»£ç \`ã€ä»£ç å—
- **åˆ—è¡¨**ï¼šæœ‰åºåˆ—è¡¨ã€æ— åºåˆ—è¡¨ã€ä»»åŠ¡åˆ—è¡¨
- **å¼•ç”¨**ï¼š> å—å¼•ç”¨
- **é“¾æ¥**ï¼š[æ–‡æœ¬](URL)ã€è‡ªåŠ¨é“¾æ¥
- **è¡¨æ ¼**ï¼šGitHubé£æ ¼è¡¨æ ¼
- **åˆ†éš”çº¿**ï¼š---

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2024å¹´12æœˆ19æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶éªŒè¯  
**æ„å»ºçŠ¶æ€**ï¼šâœ… æ„å»ºæˆåŠŸ  
**æ€§èƒ½çŠ¶æ€**ï¼šâœ… æµç•…è¿è¡Œ  
**Markdownæ”¯æŒ**ï¼šâœ… å®Œæ•´æ”¯æŒ
