# å¯¹è¯é˜Ÿåˆ—é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸš¨ é—®é¢˜ç°è±¡

1. **æ¶ˆæ¯é¡ºåºé”™è¯¯**ï¼šAIå›å¤æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†é¡¶ç«¯è€Œä¸æ˜¯åº•éƒ¨
2. **æ¶ˆæ¯è¦†ç›–é—®é¢˜**ï¼šç¬¬äºŒæ¬¡æé—®çš„å›å¤è¦†ç›–äº†ç¬¬ä¸€æ¬¡çš„å›å¤bubble
3. **æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…**ï¼šåç«¯å‘é€`type: "stream"`ï¼Œå‰ç«¯ç¼ºå°‘å¯¹åº”å¤„ç†å™¨

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. å¤šé‡æ¶ˆæ¯å¤„ç†é€»è¾‘å†²çª

ä»£ç ä¸­å­˜åœ¨**å¤šä¸ªä¸åŒçš„æµå¼æ¶ˆæ¯å¤„ç†é€»è¾‘**ï¼Œå®ƒä»¬äº’ç›¸å†²çªï¼š

```javascript
// å†²çªçš„å¤„ç†å™¨1
case "stream": {
  // ä½¿ç”¨é”™è¯¯çš„appendMsgStreamå‚æ•°æ ¼å¼
  appendMsgStream({
    _id: `${messageId}_${Date.now()}`, // âŒ é”™è¯¯ï¼šç›´æ¥ä¼ å…¥_id
    _originalId: messageId,
    // ...
  });
}

// å†²çªçš„å¤„ç†å™¨2
case "streaming": {
  // ä½¿ç”¨æ­£ç¡®çš„appendMsgStreamå‚æ•°æ ¼å¼
  appendMsgStream(
    { id: messageId, fullText, isComplete }, // âœ… æ­£ç¡®ï¼šä¼ å…¥StreamingData
    { type: "text", content: { text: ... } }  // âœ… æ­£ç¡®ï¼šä¼ å…¥msgTemplate
  );
}

// å†²çªçš„å¤„ç†å™¨3
case "response": { /* ... */ }
case "stream_start": { /* ... */ }
case "stream_chunk": { /* ... */ }
case "stream_end": { /* ... */ }
```

### 2. æ¶ˆæ¯IDç®¡ç†æ··ä¹±

- **IDå†²çª**ï¼šä¸åŒæ¶ˆæ¯å¯èƒ½ä½¿ç”¨ç›¸åŒçš„ID
- **æŸ¥æ‰¾é€»è¾‘é”™è¯¯**ï¼š`appendMsgStream`ä¸­çš„æŸ¥æ‰¾æ¡ä»¶è¿‡äºå®½æ¾
- **æ—¶é—´æˆ³å¤„ç†é”™è¯¯**ï¼šå¯¼è‡´æ¶ˆæ¯æ’åºæ··ä¹±

### 3. æ¶ˆæ¯æŸ¥æ‰¾é€»è¾‘é—®é¢˜

```typescript
// ä¿®å¤å‰ï¼šæŸ¥æ‰¾æ¡ä»¶è¿‡äºå®½æ¾
const existingIndex = prev.findIndex(
  (msg) => msg._originalId === id || msg._id === id // âŒ å¯èƒ½åŒ¹é…åˆ°é”™è¯¯çš„æ¶ˆæ¯
);

// ä¿®å¤åï¼šç²¾ç¡®åŒ¹é…
const existingIndex = prev.findIndex(
  (msg) => msg._originalId === id && msg._originalId !== undefined // âœ… ç²¾ç¡®åŒ¹é…
);
```

### 4. åç«¯å‰ç«¯æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…

**åç«¯å‘é€çš„æ¶ˆæ¯æ ¼å¼**ï¼š

```json
{
  "id": "92b0e745-c9a1-4a55-aabf-dbbdb8fa0bff",
  "from": "ai",
  "text": "è§£å†³æ–¹æ¡ˆã€‚",
  "fullText": "å½“ç„¶å¯ä»¥ï¼è¯·é—®æ‚¨éœ€è¦å¸®åŠ©è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ...",
  "timestamp": "2025-06-15T09:38:42.758Z",
  "type": "stream", // âŒ å‰ç«¯ç¼ºå°‘å¯¹åº”å¤„ç†å™¨
  "sessionId": "c8d61b79-5409-4a2a-88f9-c0367e737690",
  "isComplete": false
}
```

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ç»Ÿä¸€æ¶ˆæ¯å¤„ç†é€»è¾‘

**åˆ é™¤å†²çªçš„å¤„ç†å™¨**ï¼š

- ç§»é™¤ `case "stream"`
- ç§»é™¤ `case "response"`
- ç§»é™¤ `case "stream_start"`, `case "stream_chunk"`, `case "stream_end"`
- **é‡æ–°å®ç°** `case "stream"` ä½¿ç”¨æ­£ç¡®çš„`appendMsgStream`æ ¼å¼

### 2. ä¿®å¤æ¶ˆæ¯æŸ¥æ‰¾é€»è¾‘

```typescript
// ç¡®ä¿ç²¾ç¡®åŒ¹é…ï¼Œé¿å…æ¶ˆæ¯è¦†ç›–
const existingIndex = prev.findIndex(
  (msg) => msg._originalId === id && msg._originalId !== undefined
);
```

### 3. ä¿®å¤æ—¶é—´æˆ³å’Œæ’åº

```typescript
if (existingIndex >= 0) {
  // æ›´æ–°ç°æœ‰æ¶ˆæ¯æ—¶ä¿æŒåŸå§‹æ—¶é—´æˆ³
  createdAt: existingMsg.createdAt, // ä¿æŒåŸå§‹åˆ›å»ºæ—¶é—´
  hasTime: existingMsg.hasTime,     // ä¿æŒæ—¶é—´æ˜¾ç¤ºçŠ¶æ€
} else {
  // æ–°æ¶ˆæ¯ä½¿ç”¨å½“å‰æ—¶é—´æˆ³ï¼Œç¡®ä¿å‡ºç°åœ¨åº•éƒ¨
  const now = Date.now();
  createdAt: now, // ä½¿ç”¨å½“å‰æ—¶é—´ç¡®ä¿æ¶ˆæ¯åœ¨åº•éƒ¨
}
```

### 4. ä¼˜åŒ–IDç”Ÿæˆç­–ç•¥

```typescript
// å®Œæˆæ—¶ä½¿ç”¨åŸå§‹IDï¼Œæµå¼ä¸­ä½¿ç”¨ä¸´æ—¶ID
const finalId = isComplete ? id : `${id}_streaming_${timestamp}`;
```

### 5. ä¿®å¤åç«¯å‰ç«¯æ¶ˆæ¯ç±»å‹åŒ¹é…

**é‡æ–°å®ç°streamå¤„ç†å™¨**ï¼š

```javascript
case "stream": {
  // å¤„ç†åç«¯å‘é€çš„streamç±»å‹æ¶ˆæ¯ï¼Œè½¬æ¢ä¸ºç»Ÿä¸€çš„æµå¼å¤„ç†
  const messageId = data.id;
  const fullText = data.fullText || "";
  const isComplete = data.isComplete || false;

  // ä½¿ç”¨æ­£ç¡®çš„appendMsgStreamæ ¼å¼
  appendMsgStream(
    {
      id: messageId,
      fullText: fullText,
      isComplete: isComplete,
    },
    {
      type: "text",
      content: {
        text: createElement(StreamingText, {
          value: fullText,
          speed: 20,
        }),
      },
      user: { avatar: AIAvatar(), name: "AIåŠ©æ‰‹" },
      position: "left",
    }
  );
}
```

### 6. æ¸…ç†æœªä½¿ç”¨ä»£ç 

åˆ é™¤æœªä½¿ç”¨çš„å˜é‡å’Œå¼•ç”¨ï¼š

- `streamingMessagesRef`
- `streamingMessageRef`
- `currentStreamingMessageId`

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ AIå›å¤å‡ºç°åœ¨é¡¶éƒ¨
- âŒ ç¬¬äºŒæ¬¡æé—®è¦†ç›–ç¬¬ä¸€æ¬¡å›å¤
- âŒ æ¶ˆæ¯IDå†²çªå¯¼è‡´æ··ä¹±
- âŒ å¤šä¸ªå¤„ç†å™¨äº’ç›¸å¹²æ‰°
- âŒ `Unknown message type: stream` é”™è¯¯

### ä¿®å¤å

- âœ… AIå›å¤æ­£ç¡®å‡ºç°åœ¨ç”¨æˆ·æ¶ˆæ¯åé¢ï¼ˆåº•éƒ¨ï¼‰
- âœ… æ¯æ¬¡æé—®éƒ½æœ‰ç‹¬ç«‹çš„å›å¤bubble
- âœ… æ¶ˆæ¯æŒ‰æ—¶é—´æ­£ç¡®æ’åº
- âœ… æµå¼æ¶ˆæ¯æ­£ç¡®æ›´æ–°ï¼Œä¸åˆ›å»ºé‡å¤æ¶ˆæ¯
- âœ… æ­£ç¡®å¤„ç†åç«¯çš„streamæ¶ˆæ¯ç±»å‹
- âœ… ä»£ç é€»è¾‘æ¸…æ™°ï¼Œåªæœ‰ä¸€ä¸ªæµå¼å¤„ç†å™¨

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ ¸å¿ƒä¿®å¤ç‚¹

1. **`useMessages.ts`**ï¼š

   - ä¿®å¤ `appendMsgStream` çš„æ¶ˆæ¯æŸ¥æ‰¾é€»è¾‘
   - ç¡®ä¿æ–°æ¶ˆæ¯ä½¿ç”¨å½“å‰æ—¶é—´æˆ³å‡ºç°åœ¨åº•éƒ¨
   - æ›´æ–°æ¶ˆæ¯æ—¶ä¿æŒåŸå§‹æ—¶é—´æˆ³

2. **`useChat.js`**ï¼š
   - é‡æ–°å®ç° `case "stream"` å¤„ç†å™¨
   - ä½¿ç”¨æ­£ç¡®çš„ `appendMsgStream` å‚æ•°æ ¼å¼
   - æ¸…ç†æœªä½¿ç”¨çš„å˜é‡å’Œå¼•ç”¨
   - ç¡®ä¿ä¸åç«¯æ¶ˆæ¯æ ¼å¼åŒ¹é…

### æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ

```
ç”¨æˆ·è¾“å…¥ "ä½ å¥½"
    â†“
åç«¯è¿”å› stream æ¶ˆæ¯ (id: "msg_001", isComplete: false)
    â†“
appendMsgStream åˆ›å»ºæ–°æ¶ˆæ¯ (åº•éƒ¨ä½ç½®)
    â†“
åç«¯ç»§ç»­è¿”å› stream æ›´æ–° (id: "msg_001", isComplete: false)
    â†“
appendMsgStream æ‰¾åˆ°ç°æœ‰æ¶ˆæ¯å¹¶æ›´æ–°å†…å®¹
    â†“
åç«¯å‘é€æœ€ç»ˆ stream æ¶ˆæ¯ (id: "msg_001", isComplete: true)
    â†“
appendMsgStream å®Œæˆæ¶ˆæ¯å¹¶åœæ­¢typing
    â†“
ç”¨æˆ·è¾“å…¥ "ä½ åœ¨å“ªå„¿"
    â†“
åç«¯è¿”å› stream æ¶ˆæ¯ (id: "msg_002")  // æ–°çš„ID
    â†“
appendMsgStream åˆ›å»ºæ–°æ¶ˆæ¯ (åœ¨ msg_001 åé¢)
```

### åç«¯æ¶ˆæ¯æ ¼å¼æ”¯æŒ

ç°åœ¨æ­£ç¡®æ”¯æŒåç«¯å‘é€çš„æ¶ˆæ¯æ ¼å¼ï¼š

```json
{
  "id": "unique-message-id",
  "from": "ai",
  "text": "å½“å‰æ–‡æœ¬ç‰‡æ®µ",
  "fullText": "å®Œæ•´çš„ç´¯ç§¯æ–‡æœ¬",
  "timestamp": "2025-06-15T09:38:42.758Z",
  "type": "stream",
  "sessionId": "session-id",
  "isComplete": false
}
```

## ğŸ¯ éªŒè¯æ–¹æ³•

1. **æ¶ˆæ¯é¡ºåºæµ‹è¯•**ï¼š

   - è¾“å…¥ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¡®è®¤å›å¤å‡ºç°åœ¨é—®é¢˜ä¸‹æ–¹
   - è¾“å…¥ç¬¬äºŒä¸ªé—®é¢˜ï¼Œç¡®è®¤å›å¤å‡ºç°åœ¨ç¬¬äºŒä¸ªé—®é¢˜ä¸‹æ–¹

2. **æ¶ˆæ¯ç‹¬ç«‹æ€§æµ‹è¯•**ï¼š

   - ç¡®è®¤æ¯ä¸ªé—®é¢˜éƒ½æœ‰ç‹¬ç«‹çš„å›å¤bubble
   - ç¡®è®¤æµå¼æ›´æ–°ä¸ä¼šå½±å“å…¶ä»–æ¶ˆæ¯

3. **æµå¼æ¶ˆæ¯æµ‹è¯•**ï¼š

   - ç¡®è®¤ä¸å†å‡ºç° `Unknown message type: stream` é”™è¯¯
   - ç¡®è®¤æµå¼æ–‡æœ¬æ­£ç¡®æ˜¾ç¤ºå’Œæ›´æ–°

4. **æ„å»ºæµ‹è¯•**ï¼š
   - `npm run build` æˆåŠŸ
   - æ— linteré”™è¯¯

## ğŸ“‹ åç»­å»ºè®®

1. **åç«¯é…åˆ**ï¼šç¡®ä¿æ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰å”¯ä¸€çš„ID
2. **ç›‘æ§æ—¥å¿—**ï¼šè§‚å¯Ÿæ¶ˆæ¯å¤„ç†çš„æ§åˆ¶å°è¾“å‡º
3. **ç”¨æˆ·æµ‹è¯•**ï¼šè¿›è¡Œå¤šè½®å¯¹è¯æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ
4. **æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–**ï¼šå»ºè®®åç«¯ç»Ÿä¸€ä½¿ç”¨ä¸€ç§æ¶ˆæ¯ç±»å‹æ ¼å¼

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2024å¹´12æœˆ19æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶éªŒè¯  
**æ„å»ºçŠ¶æ€**ï¼šâœ… æ„å»ºæˆåŠŸ  
**æ¶ˆæ¯ç±»å‹æ”¯æŒ**ï¼šâœ… æ”¯æŒåç«¯streamæ¶ˆæ¯æ ¼å¼
