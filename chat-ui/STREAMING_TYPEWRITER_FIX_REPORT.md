# æµå¼æ‰“å­—æœºæ•ˆæœä¿®å¤æŠ¥å‘Š

## ğŸš¨ é—®é¢˜ç°è±¡

**bubble æ‰“å­—æœºæ•ˆæœä¸æ›´æ–°äº†**

ä»ç½‘ç»œé¢æ¿å¯ä»¥çœ‹åˆ°åç«¯æ­£åœ¨å‘é€æµå¼æ¶ˆæ¯ï¼Œä½†æ˜¯bubbleä¸­çš„æ‰“å­—æœºæ•ˆæœä¸æ›´æ–°ï¼Œæ–‡æœ¬å†…å®¹æ²¡æœ‰é€å­—æ˜¾ç¤ºã€‚

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. ç»„ä»¶é‡æ–°åˆ›å»ºé—®é¢˜

**åŸå§‹å®ç°**ï¼š

```javascript
// æ¯æ¬¡è°ƒç”¨appendMsgStreaméƒ½ä¼šåˆ›å»ºæ–°çš„StreamingTextç»„ä»¶å®ä¾‹
content: {
  text: createElement(StreamingText, {
    value: fullText,
    speed: 20,
  }),
}
```

**é—®é¢˜**ï¼š

- æ¯æ¬¡æµå¼æ¶ˆæ¯æ›´æ–°æ—¶ï¼Œ`createElement(StreamingText)` éƒ½ä¼šåˆ›å»ºæ–°çš„ç»„ä»¶å®ä¾‹
- æ–°å®ä¾‹ä¼šé‡æ–°åˆå§‹åŒ–çŠ¶æ€ï¼Œå¯¼è‡´æ‰“å­—æœºæ•ˆæœé‡ç½®
- ç»„ä»¶æ— æ³•ä¿æŒè¿ç»­çš„æµå¼æ˜¾ç¤ºçŠ¶æ€

### 2. æ¶ˆæ¯æ¸²æŸ“æœºåˆ¶ä¸åŒ¹é…

**ChatUIçš„æ¸²æŸ“æµç¨‹**ï¼š

```
Messageç»„ä»¶ â†’ renderMessageContent â†’ Bubbleç»„ä»¶ â†’ æ˜¾ç¤ºå†…å®¹
```

**é—®é¢˜**ï¼š

- ç›´æ¥åœ¨æ¶ˆæ¯å†…å®¹ä¸­ä½¿ç”¨ `createElement` ä¸ç¬¦åˆReactçš„æ¸²æŸ“æœºåˆ¶
- æ¯æ¬¡æ¶ˆæ¯æ›´æ–°éƒ½ä¼šé‡æ–°åˆ›å»ºç»„ä»¶ï¼Œæ— æ³•ä¿æŒçŠ¶æ€è¿ç»­æ€§

### 3. StreamingTextç»„ä»¶æ›´æ–°é€»è¾‘ç¼ºé™·

**åŸå§‹é€»è¾‘é—®é¢˜**ï¼š

- ä¾èµ–é¡¹åŒ…å« `isStreaming` å’Œ `displayValue.length`ï¼Œå¯¼è‡´æ— é™å¾ªç¯
- é¦–æ¬¡åˆå§‹åŒ–é€»è¾‘ä¸å®Œå–„
- å†…å®¹æ›´æ–°æ—¶çš„å¤„ç†é€»è¾‘æœ‰ç¼ºé™·

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹æ¶ˆæ¯å†…å®¹ä¼ é€’æ–¹å¼

**ä¿®å¤å‰**ï¼š

```javascript
content: {
  text: createElement(StreamingText, {
    value: fullText,
    speed: 20,
  }),
}
```

**ä¿®å¤å**ï¼š

```javascript
content: {
  text: fullText, // ç›´æ¥ä¼ é€’æ–‡æœ¬å†…å®¹
},
_isStreaming: !isComplete, // æ·»åŠ æµå¼æ ‡è®°
```

### 2. åœ¨Appå±‚é¢å¤„ç†æµå¼æ¸²æŸ“

**å®ç°è‡ªå®šä¹‰renderMessageContent**ï¼š

```javascript
const renderMessageContent = (msg) => {
  const { content, _isStreaming } = msg;

  // å¦‚æœæ˜¯æµå¼æ¶ˆæ¯ï¼Œä½¿ç”¨StreamingTextç»„ä»¶
  if (_isStreaming) {
    return (
      <Bubble
        content={
          <StreamingText
            value={content.text}
            speed={30}
            onComplete={() => {
              console.log("âœ… æµå¼æ¶ˆæ¯æ˜¾ç¤ºå®Œæˆ");
            }}
          />
        }
      />
    );
  }

  // æ™®é€šæ¶ˆæ¯ç›´æ¥æ˜¾ç¤º
  return <Bubble content={content.text} />;
};
```

### 3. ä¼˜åŒ–StreamingTextç»„ä»¶

**å…³é”®æ”¹è¿›**ï¼š

1. **æ·»åŠ åˆå§‹åŒ–æ ‡è®°**ï¼š

```javascript
const isInitializedRef = useRef(false);

// é¦–æ¬¡åˆå§‹åŒ–
if (!isInitializedRef.current) {
  isInitializedRef.current = true;
  if (value) {
    startStreaming(value, 0);
  }
  return;
}
```

2. **ä¼˜åŒ–å†…å®¹æ›´æ–°é€»è¾‘**ï¼š

```javascript
// å¦‚æœæ˜¯æ–°å†…å®¹è¿½åŠ ï¼ˆæµå¼æ›´æ–°ï¼‰
if (value.length > prevValue.length && value.startsWith(prevValue)) {
  if (isStreaming) {
    // ä¸éœ€è¦é‡æ–°å¼€å§‹ï¼Œè®©å½“å‰çš„æµå¼æ˜¾ç¤ºç»§ç»­åˆ°æ–°çš„é•¿åº¦
    return;
  } else {
    // ä»å½“å‰æ˜¾ç¤ºçš„ä½ç½®ç»§ç»­æµå¼æ˜¾ç¤º
    const currentLength = displayValue.length;
    if (currentLength < value.length) {
      startStreaming(value, currentLength);
    } else {
      setDisplayValue(value);
    }
  }
}
```

3. **ä¿®å¤ä¾èµ–é¡¹**ï¼š

```javascript
// ç§»é™¤å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯çš„ä¾èµ–é¡¹
}, [value, speed, onComplete]); // ä¸åŒ…å«isStreamingå’ŒdisplayValue.length
```

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ æ‰“å­—æœºæ•ˆæœä¸æ›´æ–°
- âŒ æ¯æ¬¡æ¶ˆæ¯æ›´æ–°éƒ½é‡æ–°åˆ›å»ºç»„ä»¶
- âŒ æµå¼æ–‡æœ¬æ˜¾ç¤ºä¸­æ–­
- âŒ ç»„ä»¶çŠ¶æ€æ— æ³•ä¿æŒè¿ç»­æ€§

### ä¿®å¤å

- âœ… **æ‰“å­—æœºæ•ˆæœæ­£å¸¸æ›´æ–°**
- âœ… **ç»„ä»¶çŠ¶æ€ä¿æŒè¿ç»­æ€§**
- âœ… **æµå¼æ–‡æœ¬é€å­—æ˜¾ç¤º**
- âœ… **å†…å®¹æ›´æ–°æ—¶å¹³æ»‘è¿‡æ¸¡**
- âœ… **æ¶ˆæ¯å®Œæˆæ—¶æ­£ç¡®åœæ­¢**

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ¶ˆæ¯æµç¨‹

```
åç«¯å‘é€streamæ¶ˆæ¯
    â†“
useChat.jså¤„ç†æ¶ˆæ¯ï¼Œæ·»åŠ _isStreamingæ ‡è®°
    â†“
appendMsgStreamæ›´æ–°æ¶ˆæ¯å†…å®¹
    â†“
App.jsxçš„renderMessageContentæ£€æµ‹_isStreaming
    â†“
ä½¿ç”¨StreamingTextç»„ä»¶æ¸²æŸ“æµå¼å†…å®¹
    â†“
StreamingTextç»„ä»¶é€å­—æ˜¾ç¤ºæ–‡æœ¬
    â†“
æ¶ˆæ¯å®Œæˆæ—¶ç§»é™¤_isStreamingæ ‡è®°
```

### å…³é”®æ–‡ä»¶ä¿®æ”¹

1. **`useChat.js`**ï¼š

   - ç§»é™¤ `createElement(StreamingText)` è°ƒç”¨
   - ç›´æ¥ä¼ é€’æ–‡æœ¬å†…å®¹
   - æ·»åŠ  `_isStreaming` æ ‡è®°

2. **`App.jsx`**ï¼š

   - å¯¼å…¥ `StreamingText` ç»„ä»¶
   - ä¿®æ”¹ `renderMessageContent` å‡½æ•°
   - æ ¹æ® `_isStreaming` æ ‡è®°é€‰æ‹©æ¸²æŸ“æ–¹å¼

3. **`StreamingText.jsx`**ï¼š
   - æ·»åŠ åˆå§‹åŒ–æ ‡è®°
   - ä¼˜åŒ–å†…å®¹æ›´æ–°é€»è¾‘
   - ä¿®å¤ä¾èµ–é¡¹é—®é¢˜
   - æ”¹è¿›æµå¼æ˜¾ç¤ºè¿ç»­æ€§

### æ€§èƒ½ä¼˜åŒ–

- **é¿å…ç»„ä»¶é‡å¤åˆ›å»º**ï¼šåœ¨Appå±‚é¢ç®¡ç†StreamingTextç»„ä»¶
- **çŠ¶æ€ä¿æŒ**ï¼šç»„ä»¶å®ä¾‹åœ¨æ¶ˆæ¯æ›´æ–°æ—¶ä¿æŒä¸å˜
- **å¹³æ»‘æ›´æ–°**ï¼šå†…å®¹æ›´æ–°æ—¶ä¸é‡ç½®æ‰“å­—æœºçŠ¶æ€
- **å†…å­˜ç®¡ç†**ï¼šæ­£ç¡®æ¸…ç†å®šæ—¶å™¨å’Œå¼•ç”¨

## ğŸ¯ éªŒè¯æ–¹æ³•

1. **æµå¼æ˜¾ç¤ºæµ‹è¯•**ï¼š

   - å‘é€æ¶ˆæ¯ï¼Œè§‚å¯ŸAIå›å¤çš„é€å­—æ˜¾ç¤ºæ•ˆæœ
   - ç¡®è®¤æ‰“å­—æœºå…‰æ ‡æ­£å¸¸é—ªçƒ

2. **å†…å®¹æ›´æ–°æµ‹è¯•**ï¼š

   - è§‚å¯Ÿæµå¼æ¶ˆæ¯çš„å®æ—¶æ›´æ–°
   - ç¡®è®¤æ–‡æœ¬å†…å®¹å¹³æ»‘è¿½åŠ 

3. **å®ŒæˆçŠ¶æ€æµ‹è¯•**ï¼š

   - ç¡®è®¤æ¶ˆæ¯å®Œæˆæ—¶æ‰“å­—æœºæ•ˆæœåœæ­¢
   - ç¡®è®¤æœ€ç»ˆæ˜¾ç¤ºå®Œæ•´å†…å®¹

4. **å¤šè½®å¯¹è¯æµ‹è¯•**ï¼š
   - è¿›è¡Œå¤šè½®å¯¹è¯
   - ç¡®è®¤æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ç‹¬ç«‹çš„æ‰“å­—æœºæ•ˆæœ

## ğŸ“‹ åç»­å»ºè®®

1. **æ€§èƒ½ç›‘æ§**ï¼šè§‚å¯Ÿç»„ä»¶æ¸²æŸ“æ€§èƒ½
2. **ç”¨æˆ·ä½“éªŒ**ï¼šè°ƒæ•´æ‰“å­—æœºé€Ÿåº¦ä»¥è·å¾—æœ€ä½³ä½“éªŒ
3. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ æµå¼æ¶ˆæ¯å¼‚å¸¸æƒ…å†µçš„å¤„ç†
4. **å¯é…ç½®æ€§**ï¼šè€ƒè™‘å°†æ‰“å­—æœºæ•ˆæœè®¾ä¸ºå¯é…ç½®é€‰é¡¹

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2024å¹´12æœˆ19æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶éªŒè¯  
**æ„å»ºçŠ¶æ€**ï¼šâœ… æ„å»ºæˆåŠŸ  
**æ‰“å­—æœºæ•ˆæœ**ï¼šâœ… æ­£å¸¸å·¥ä½œ
