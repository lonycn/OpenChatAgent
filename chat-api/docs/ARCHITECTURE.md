# ğŸ—ï¸ Chat API æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ¨¡å—è®¾è®¡](#æ¨¡å—è®¾è®¡)
- [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
- [å®‰å…¨æ¶æ„](#å®‰å…¨æ¶æ„)
- [æ€§èƒ½è®¾è®¡](#æ€§èƒ½è®¾è®¡)

## ğŸ›ï¸ ç³»ç»Ÿæ¶æ„

### ğŸ”„ æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Chat API ç»Ÿä¸€æœåŠ¡                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ API Gateway (FastAPI)                                   â”‚
â”‚  â”œâ”€â”€ ğŸ”’ è®¤è¯ä¸­é—´ä»¶ (JWT)                                      â”‚
â”‚  â”œâ”€â”€ ğŸ“Š æ—¥å¿—ä¸­é—´ä»¶ (Logging)                                  â”‚
â”‚  â”œâ”€â”€ ğŸ›¡ï¸ å®‰å…¨ä¸­é—´ä»¶ (CORS, Rate Limit)                        â”‚
â”‚  â””â”€â”€ ğŸ“ˆ ç›‘æ§ä¸­é—´ä»¶ (Metrics)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¡ WebSocket æœåŠ¡å±‚                                         â”‚
â”‚  â”œâ”€â”€ ğŸ”Œ è¿æ¥ç®¡ç†å™¨ (ConnectionManager)                        â”‚
â”‚  â”œâ”€â”€ ğŸ“¨ æ¶ˆæ¯è·¯ç”±å™¨ (MessageRouter)                           â”‚
â”‚  â”œâ”€â”€ ğŸ”„ çŠ¶æ€åŒæ­¥å™¨ (StateSync)                               â”‚
â”‚  â””â”€â”€ ğŸ“¢ å¹¿æ’­æœåŠ¡ (BroadcastService)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ§  ä¸šåŠ¡æœåŠ¡å±‚                                               â”‚
â”‚  â”œâ”€â”€ ğŸ¤– AI æœåŠ¡ (AIService)                                 â”‚
â”‚  â”œâ”€â”€ ğŸ’¾ ä¼šè¯æœåŠ¡ (SessionService)                            â”‚
â”‚  â”œâ”€â”€ ğŸ‘¥ ç”¨æˆ·æœåŠ¡ (UserService)                               â”‚
â”‚  â”œâ”€â”€ ğŸ’¬ å¯¹è¯æœåŠ¡ (ConversationService)                       â”‚
â”‚  â””â”€â”€ ğŸ“Š ç»Ÿè®¡æœåŠ¡ (AnalyticsService)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¾ æ•°æ®è®¿é—®å±‚                                               â”‚
â”‚  â”œâ”€â”€ ğŸ—„ï¸ MySQL ä»“å‚¨ (Repository Pattern)                     â”‚
â”‚  â”œâ”€â”€ ğŸ”´ Redis ç¼“å­˜ (Cache Layer)                            â”‚
â”‚  â”œâ”€â”€ ğŸ“ æ—¥å¿—å­˜å‚¨ (Log Storage)                               â”‚
â”‚  â””â”€â”€ ğŸ“ æ–‡ä»¶å­˜å‚¨ (File Storage)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”§ æœåŠ¡æ•´åˆæ˜ å°„

| åŸæœåŠ¡ | ç«¯å£ | æ–°æ¨¡å— | åŠŸèƒ½æè¿° |
|--------|------|--------|----------|
| chat-core | 8001 | `websocket/` | WebSocket æ¶ˆæ¯ç½‘å…³ |
| ai-service | 8003 | `ai/` | AI æœåŠ¡å°è£… |
| chat-session | 8004 | `session/` | ä¼šè¯ç®¡ç† |
| chat-admin | 8005 | `admin/` | ç®¡ç†åå° |

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### ğŸ æ ¸å¿ƒæŠ€æœ¯
- **Python**: 3.11+
- **FastAPI**: ç°ä»£é«˜æ€§èƒ½ Web æ¡†æ¶
- **WebSockets**: å®æ—¶é€šä¿¡
- **asyncio**: å¼‚æ­¥ç¼–ç¨‹
- **Pydantic**: æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–

### ğŸ’¾ æ•°æ®å­˜å‚¨
- **MySQL**: ä¸»æ•°æ®åº“ (ç”¨æˆ·ã€å¯¹è¯ã€æ¶ˆæ¯)
- **Redis**: ç¼“å­˜å’Œä¼šè¯å­˜å‚¨
- **SQLAlchemy**: ORM æ¡†æ¶
- **Alembic**: æ•°æ®åº“è¿ç§»

### ğŸ¤– AI é›†æˆ
- **é˜¿é‡Œç™¾ç‚¼**: DashScope API
- **OpenAI**: å…¼å®¹æ¥å£ (å¯é€‰)
- **httpx**: å¼‚æ­¥ HTTP å®¢æˆ·ç«¯

### ğŸ”§ å·¥å…·åº“
- **uvicorn**: ASGI æœåŠ¡å™¨
- **python-jose**: JWT å¤„ç†
- **passlib**: å¯†ç åŠ å¯†
- **python-multipart**: æ–‡ä»¶ä¸Šä¼ 
- **loguru**: æ—¥å¿—å¤„ç†

## ğŸ“¦ æ¨¡å—è®¾è®¡

### ğŸŒ API æ¨¡å— (`api/`)
```python
api/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ deps.py              # ä¾èµ–æ³¨å…¥
â”œâ”€â”€ auth/               # è®¤è¯ç›¸å…³
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ router.py       # è®¤è¯è·¯ç”±
â”‚   â””â”€â”€ service.py      # è®¤è¯æœåŠ¡
â”œâ”€â”€ admin/              # ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ users.py        # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ conversations.py # å¯¹è¯ç®¡ç†
â”‚   â””â”€â”€ analytics.py    # æ•°æ®ç»Ÿè®¡
â”œâ”€â”€ chat/               # èŠå¤©æ¥å£
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ sessions.py     # ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ messages.py     # æ¶ˆæ¯å¤„ç†
â””â”€â”€ health.py           # å¥åº·æ£€æŸ¥
```

### ğŸ“¡ WebSocket æ¨¡å— (`websocket/`)
```python
websocket/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ manager.py          # è¿æ¥ç®¡ç†å™¨
â”œâ”€â”€ router.py           # æ¶ˆæ¯è·¯ç”±å™¨
â”œâ”€â”€ handlers/           # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chat.py         # èŠå¤©æ¶ˆæ¯
â”‚   â”œâ”€â”€ system.py       # ç³»ç»Ÿæ¶ˆæ¯
â”‚   â””â”€â”€ admin.py        # ç®¡ç†æ¶ˆæ¯
â””â”€â”€ events.py           # äº‹ä»¶å®šä¹‰
```

### ğŸ¤– AI æ¨¡å— (`ai/`)
```python
ai/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ client.py           # AI å®¢æˆ·ç«¯
â”œâ”€â”€ dashscope.py        # é˜¿é‡Œç™¾ç‚¼é›†æˆ
â”œâ”€â”€ openai.py           # OpenAI å…¼å®¹
â”œâ”€â”€ knowledge.py        # çŸ¥è¯†åº“ç®¡ç†
â””â”€â”€ context.py          # ä¸Šä¸‹æ–‡ç®¡ç†
```

### ğŸ’¾ ä¼šè¯æ¨¡å— (`session/`)
```python
session/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ manager.py          # ä¼šè¯ç®¡ç†å™¨
â”œâ”€â”€ storage.py          # å­˜å‚¨æ¥å£
â”œâ”€â”€ redis_storage.py    # Redis å®ç°
â””â”€â”€ models.py           # ä¼šè¯æ¨¡å‹
```

### ğŸ‘¥ ç®¡ç†æ¨¡å— (`admin/`)
```python
admin/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ auth.py             # è®¤è¯æˆæƒ
â”œâ”€â”€ users.py            # ç”¨æˆ·ç®¡ç†
â”œâ”€â”€ conversations.py    # å¯¹è¯ç®¡ç†
â”œâ”€â”€ customers.py        # å®¢æˆ·ç®¡ç†
â””â”€â”€ analytics.py        # æ•°æ®åˆ†æ
```

## ğŸ”„ æ•°æ®æµè®¾è®¡

### ğŸ’¬ èŠå¤©æ¶ˆæ¯æµ
```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant W as WebSocket
    participant R as æ¶ˆæ¯è·¯ç”±å™¨
    participant S as ä¼šè¯æœåŠ¡
    participant A as AIæœåŠ¡
    participant D as æ•°æ®åº“

    C->>W: å‘é€æ¶ˆæ¯
    W->>R: è·¯ç”±æ¶ˆæ¯
    R->>S: è·å–ä¼šè¯çŠ¶æ€
    S->>D: æŸ¥è¯¢ä¼šè¯ä¿¡æ¯
    D-->>S: è¿”å›ä¼šè¯çŠ¶æ€
    S-->>R: è¿”å›çŠ¶æ€ (AI/äººå·¥)
    
    alt AI æ¨¡å¼
        R->>A: è°ƒç”¨ AI æœåŠ¡
        A-->>R: è¿”å› AI å›å¤
    else äººå·¥æ¨¡å¼
        R->>W: è½¬å‘ç»™å®¢æœ
    end
    
    R->>D: ä¿å­˜æ¶ˆæ¯è®°å½•
    R->>W: æ¨é€å›å¤
    W->>C: å‘é€å›å¤
```

### ğŸ”„ çŠ¶æ€åˆ‡æ¢æµ
```mermaid
stateDiagram-v2
    [*] --> AIæ¨¡å¼
    AIæ¨¡å¼ --> äººå·¥æ¨¡å¼: å®¢æœæ¥ç®¡
    äººå·¥æ¨¡å¼ --> AIæ¨¡å¼: ä¼šè¯ç»“æŸ
    AIæ¨¡å¼ --> ç­‰å¾…ä¸­: éœ€è¦äººå·¥
    ç­‰å¾…ä¸­ --> äººå·¥æ¨¡å¼: å®¢æœå“åº”
    ç­‰å¾…ä¸­ --> AIæ¨¡å¼: è¶…æ—¶å›é€€
    äººå·¥æ¨¡å¼ --> [*]: ä¼šè¯å…³é—­
    AIæ¨¡å¼ --> [*]: ä¼šè¯å…³é—­
```

## ğŸ”’ å®‰å…¨æ¶æ„

### ğŸ›¡ï¸ è®¤è¯æˆæƒ
```python
# JWT è®¤è¯æµç¨‹
class AuthService:
    async def authenticate(self, token: str) -> User:
        """éªŒè¯ JWT ä»¤ç‰Œ"""
        payload = jwt.decode(token, SECRET_KEY)
        user = await self.get_user(payload["sub"])
        return user
    
    async def authorize(self, user: User, permission: str) -> bool:
        """æƒé™éªŒè¯"""
        return permission in user.permissions
```

### ğŸ” æ•°æ®åŠ å¯†
- **ä¼ è¾“åŠ å¯†**: HTTPS/WSS
- **å­˜å‚¨åŠ å¯†**: æ•æ„Ÿå­—æ®µ AES åŠ å¯†
- **å¯†ç åŠ å¯†**: bcrypt å“ˆå¸Œ

### ğŸš« å®‰å…¨é˜²æŠ¤
- **CORS**: è·¨åŸŸè¯·æ±‚æ§åˆ¶
- **Rate Limiting**: API è¯·æ±‚é™æµ
- **Input Validation**: è¾“å…¥æ•°æ®éªŒè¯
- **SQL Injection**: ORM é˜²æ³¨å…¥

## âš¡ æ€§èƒ½è®¾è®¡

### ğŸ”„ å¼‚æ­¥æ¶æ„
```python
# å¼‚æ­¥å¤„ç†ç¤ºä¾‹
class MessageHandler:
    async def handle_message(self, message: Message):
        """å¼‚æ­¥æ¶ˆæ¯å¤„ç†"""
        # å¹¶å‘å¤„ç†å¤šä¸ªä»»åŠ¡
        tasks = [
            self.save_message(message),
            self.route_message(message),
            self.update_session(message.session_id)
        ]
        await asyncio.gather(*tasks)
```

### ğŸ’¾ ç¼“å­˜ç­–ç•¥
- **L1 ç¼“å­˜**: å†…å­˜ç¼“å­˜ (LRU)
- **L2 ç¼“å­˜**: Redis ç¼“å­˜
- **ç¼“å­˜é¢„çƒ­**: å¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
- **ç¼“å­˜å¤±æ•ˆ**: TTL + ä¸»åŠ¨å¤±æ•ˆ

### ğŸ“Š æ€§èƒ½ç›‘æ§
```python
# æ€§èƒ½ç›‘æ§è£…é¥°å™¨
@monitor_performance
async def api_endpoint():
    """ç›‘æ§ API æ€§èƒ½"""
    pass
```

### ğŸ”§ ä¼˜åŒ–ç­–ç•¥
- **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± 
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æ•°æ®åº“æ“ä½œ
- **ç´¢å¼•ä¼˜åŒ–**: æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- **å‹ç¼©ä¼ è¾“**: Gzip å‹ç¼©

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

### ğŸ”Œ æ’ä»¶ç³»ç»Ÿ
```python
# æ’ä»¶æ¥å£
class Plugin:
    async def on_message(self, message: Message):
        """æ¶ˆæ¯å¤„ç†é’©å­"""
        pass
    
    async def on_session_start(self, session: Session):
        """ä¼šè¯å¼€å§‹é’©å­"""
        pass
```

### ğŸŒ å¾®æœåŠ¡å°±ç»ª
- **æœåŠ¡å‘ç°**: æ”¯æŒæœåŠ¡æ³¨å†Œå‘ç°
- **é…ç½®ä¸­å¿ƒ**: å¤–éƒ¨é…ç½®ç®¡ç†
- **é“¾è·¯è¿½è¸ª**: åˆ†å¸ƒå¼è¿½è¸ª
- **ç†”æ–­é™çº§**: æœåŠ¡å®¹é”™

## ğŸ“Š ç›‘æ§ä½“ç³»

### ğŸ“ˆ æŒ‡æ ‡ç›‘æ§
- **ä¸šåŠ¡æŒ‡æ ‡**: æ¶ˆæ¯é‡ã€ä¼šè¯æ•°ã€å“åº”æ—¶é—´
- **ç³»ç»ŸæŒ‡æ ‡**: CPUã€å†…å­˜ã€ç½‘ç»œã€ç£ç›˜
- **åº”ç”¨æŒ‡æ ‡**: é”™è¯¯ç‡ã€ååé‡ã€å»¶è¿Ÿ

### ğŸ“ æ—¥å¿—ä½“ç³»
```python
# ç»“æ„åŒ–æ—¥å¿—
logger.info(
    "Message processed",
    extra={
        "session_id": session_id,
        "user_id": user_id,
        "message_type": message_type,
        "processing_time": processing_time
    }
)
```

### ğŸš¨ å‘Šè­¦æœºåˆ¶
- **é˜ˆå€¼å‘Šè­¦**: æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼
- **å¼‚å¸¸å‘Šè­¦**: ç³»ç»Ÿå¼‚å¸¸
- **ä¸šåŠ¡å‘Šè­¦**: ä¸šåŠ¡å¼‚å¸¸

è¿™ä¸ªæ¶æ„è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„é«˜æ€§èƒ½ã€é«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§ï¼Œä¸ºåç»­çš„å¼€å‘å’Œè¿ç»´æä¾›äº†åšå®çš„åŸºç¡€ã€‚
