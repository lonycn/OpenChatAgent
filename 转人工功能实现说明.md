# è½¬äººå·¥åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡å®ç°äº†å®Œæ•´çš„è½¬äººå·¥åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥ä»AIå¯¹è¯æ— ç¼è½¬æ¢åˆ°äººå·¥å®¢æœï¼Œå¹¶é€šè¿‡WebSocketå®ç°å®æ—¶é€šä¿¡ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿç»„ä»¶
1. **chat-front**: ç”¨æˆ·å‰ç«¯ç•Œé¢ï¼Œæ”¯æŒAIå¯¹è¯å’Œè½¬äººå·¥è¯·æ±‚
2. **chat-api**: åç«¯APIæœåŠ¡ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘å’ŒWebSocketé€šä¿¡
3. **chat-admin**: ç®¡ç†å‘˜ç•Œé¢ï¼Œå¤„ç†è½¬äººå·¥è¯·æ±‚å’Œäººå·¥å›å¤

### æ•°æ®æµç¨‹
```
ç”¨æˆ·å‘èµ·è½¬äººå·¥ â†’ chat-front â†’ WebSocket â†’ chat-api â†’ æ•°æ®åº“æ›´æ–° â†’ é€šçŸ¥chat-admin â†’ äººå·¥å¤„ç†
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. chat-api åç«¯æ”¹è¿›

#### WebSocket æ¶ˆæ¯å¤„ç†
- **æ–‡ä»¶**: `chat-api/src/websocket/router.py`
- **æ–°å¢åŠŸèƒ½**:
  - `handle_system_message()`: å¤„ç†ç³»ç»Ÿæ¶ˆæ¯ï¼ˆè½¬äººå·¥ã€AIæ¥ç®¡ï¼‰
  - `handle_handover_request()`: å¤„ç†è½¬äººå·¥è¯·æ±‚
  - `handle_ai_takeover()`: å¤„ç†AIæ¥ç®¡è¯·æ±‚
  - `notify_admin_handover_request()`: é€šçŸ¥ç®¡ç†å‘˜

#### å¯¹è¯æœåŠ¡æ‰©å±•
- **æ–‡ä»¶**: `chat-api/src/services/conversation.py`
- **æ–°å¢æ–¹æ³•**:
  - `get_conversation_by_session_id()`: æ ¹æ®ä¼šè¯IDè·å–å¯¹è¯
  - `get_or_create_conversation_by_session()`: è·å–æˆ–åˆ›å»ºå¯¹è¯

#### ç®¡ç†å‘˜API
- **æ–‡ä»¶**: `chat-api/src/api/admin.py`
- **ç°æœ‰åŠŸèƒ½**:
  - è·å–å¯¹è¯åˆ—è¡¨
  - è·å–å¯¹è¯æ¶ˆæ¯
  - æ¥ç®¡å¯¹è¯
  - å‘é€æ¶ˆæ¯
  - åˆ‡æ¢ä»£ç†ç±»å‹

### 2. chat-front å‰ç«¯åŠŸèƒ½

#### ç°æœ‰åŠŸèƒ½
- **æ–‡ä»¶**: `chat-front/src/hooks/useChat.ts`, `chat-front/src/hooks/useStreamingChat.ts`
- **è½¬äººå·¥åŠŸèƒ½**:
  - `requestHandover()`: å‘é€è½¬äººå·¥è¯·æ±‚
  - `requestAITakeover()`: è¯·æ±‚AIæ¥ç®¡
  - WebSocketæ¶ˆæ¯å¤„ç†

#### ç”¨æˆ·ç•Œé¢
- **æ–‡ä»¶**: `chat-front/src/components/ChatInterface.tsx`
- **åŠŸèƒ½**: è½¬äººå·¥æŒ‰é’®å’ŒçŠ¶æ€æ˜¾ç¤º

### 3. chat-admin ç®¡ç†ç•Œé¢

#### WebSocket æœåŠ¡
- **æ–‡ä»¶**: `chat-admin/src/utils/websocket.ts`
- **åŠŸèƒ½**: ç®¡ç†å‘˜ä¸“ç”¨WebSocketè¿æ¥ç®¡ç†

#### ç»„åˆå¼API
- **æ–‡ä»¶**: `chat-admin/src/composables/useAdminWebSocket.ts`
- **åŠŸèƒ½**:
  - WebSocketè¿æ¥ç®¡ç†
  - å®æ—¶é€šçŸ¥å¤„ç†
  - è½¬äººå·¥è¯·æ±‚å¤„ç†
  - æ¶ˆæ¯å‘é€

#### å¯¹è¯ç®¡ç†ç•Œé¢
- **æ–‡ä»¶**: `chat-admin/src/views/conversations/index.vue`
- **åŠŸèƒ½**:
  - å®æ—¶å¯¹è¯åˆ—è¡¨
  - æ¶ˆæ¯æ˜¾ç¤ºå’Œå‘é€
  - æ¥ç®¡ä¼šè¯
  - åˆ‡æ¢AI/äººå·¥æ¨¡å¼

#### API é›†æˆ
- **æ–‡ä»¶**: `chat-admin/src/api/conversations/index.ts`
- **æ›´æ–°**: è¿æ¥çœŸå®åç«¯APIè€Œéæ¨¡æ‹Ÿæ•°æ®

## ğŸ”„ å·¥ä½œæµç¨‹

### è½¬äººå·¥æµç¨‹
1. **ç”¨æˆ·è¯·æ±‚**: ç”¨æˆ·åœ¨chat-frontç‚¹å‡»"è½¬äººå·¥"æŒ‰é’®
2. **WebSocketå‘é€**: å‰ç«¯é€šè¿‡WebSocketå‘é€è½¬äººå·¥è¯·æ±‚
3. **åç«¯å¤„ç†**: chat-apiæ¥æ”¶è¯·æ±‚ï¼Œæ›´æ–°æ•°æ®åº“çŠ¶æ€
4. **é€šçŸ¥ç®¡ç†å‘˜**: å‘chat-adminå‘é€å®æ—¶é€šçŸ¥
5. **äººå·¥æ¥ç®¡**: ç®¡ç†å‘˜åœ¨chat-adminä¸­çœ‹åˆ°è¯·æ±‚å¹¶æ¥ç®¡
6. **å®æ—¶å¯¹è¯**: ç®¡ç†å‘˜ä¸ç”¨æˆ·è¿›è¡Œå®æ—¶å¯¹è¯

### AIæ¥ç®¡æµç¨‹
1. **ç®¡ç†å‘˜æ“ä½œ**: åœ¨chat-adminä¸­ç‚¹å‡»"åˆ‡æ¢åˆ°AI"
2. **WebSocketé€šçŸ¥**: é€šè¿‡WebSocketå‘é€åˆ‡æ¢è¯·æ±‚
3. **çŠ¶æ€æ›´æ–°**: åç«¯æ›´æ–°å¯¹è¯çŠ¶æ€ä¸ºAIå¤„ç†
4. **å‰ç«¯æ›´æ–°**: chat-frontæ”¶åˆ°çŠ¶æ€å˜æ›´é€šçŸ¥

## ğŸ“¡ WebSocket æ¶ˆæ¯æ ¼å¼

### è½¬äººå·¥è¯·æ±‚
```json
{
  "type": "system",
  "action": "request_handover",
  "text": "ç”¨æˆ·è¯·æ±‚è½¬äººå·¥å®¢æœ",
  "userId": "user_123",
  "sessionId": "session_456",
  "timestamp": "2024-06-17T10:00:00Z"
}
```

### AIæ¥ç®¡è¯·æ±‚
```json
{
  "type": "system",
  "action": "ai_takeover",
  "text": "è¯·æ±‚AIæ¥ç®¡å¯¹è¯",
  "userId": "user_123",
  "sessionId": "session_456",
  "timestamp": "2024-06-17T10:00:00Z"
}
```

### ç®¡ç†å‘˜æ¶ˆæ¯
```json
{
  "type": "admin_message",
  "data": {
    "conversation_id": "conv_123",
    "content": "æ‚¨å¥½ï¼Œæˆ‘æ˜¯äººå·¥å®¢æœ",
    "sender_id": "admin_456",
    "sender_name": "å®¢æœå°ç‹"
  }
}
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### å¯¹è¯è¡¨ (conversations)
- `current_agent_type`: AI | HUMAN
- `assignee_id`: æŒ‡æ´¾çš„å®¢æœID
- `agent_switched_at`: ä»£ç†åˆ‡æ¢æ—¶é—´
- `status`: OPEN | PENDING | RESOLVED | CLOSED

### æ¶ˆæ¯è¡¨ (messages)
- `sender_type`: CUSTOMER | AGENT | AI | SYSTEM
- `conversation_id`: å…³è”çš„å¯¹è¯ID
- `is_private`: æ˜¯å¦ä¸ºç§æœ‰æ¶ˆæ¯ï¼ˆå¤‡æ³¨ï¼‰

## ğŸš€ éƒ¨ç½²å’Œæµ‹è¯•

### å¯åŠ¨æœåŠ¡
```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬å¯åŠ¨æ‰€æœ‰æœåŠ¡
./test-handover.sh
```

### æœåŠ¡åœ°å€
- **chat-api**: http://localhost:8000
- **chat-front**: http://localhost:5173  
- **chat-admin**: http://localhost:5174
- **APIæ–‡æ¡£**: http://localhost:8000/docs

### æµ‹è¯•æ­¥éª¤
1. æ‰“å¼€ chat-frontï¼Œä¸AIå¯¹è¯
2. ç‚¹å‡»"è½¬äººå·¥"æŒ‰é’®
3. æ‰“å¼€ chat-adminï¼ŒæŸ¥çœ‹è½¬äººå·¥é€šçŸ¥
4. æ¥ç®¡ä¼šè¯å¹¶è¿›è¡Œäººå·¥å›å¤
5. æµ‹è¯•AIæ¥ç®¡åŠŸèƒ½

## ğŸ” å…³é”®ç‰¹æ€§

### å®æ—¶é€šä¿¡
- WebSocketåŒå‘é€šä¿¡
- å®æ—¶çŠ¶æ€åŒæ­¥
- æ¶ˆæ¯å³æ—¶æ¨é€

### çŠ¶æ€ç®¡ç†
- å¯¹è¯çŠ¶æ€è·Ÿè¸ª
- ä»£ç†ç±»å‹åˆ‡æ¢
- ä¼šè¯æŒä¹…åŒ–

### ç”¨æˆ·ä½“éªŒ
- æ— ç¼è½¬æ¢ä½“éªŒ
- å®æ—¶çŠ¶æ€æç¤º
- æ¶ˆæ¯å†å²ä¿æŒ

### ç®¡ç†åŠŸèƒ½
- å®æ—¶é€šçŸ¥ç³»ç»Ÿ
- å¯¹è¯åˆ—è¡¨ç®¡ç†
- æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- çŠ¶æ€åˆ‡æ¢æ§åˆ¶

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯
- **FastAPI**: Webæ¡†æ¶
- **WebSocket**: å®æ—¶é€šä¿¡
- **SQLAlchemy**: ORM
- **MySQL**: æ•°æ®åº“
- **Redis**: ä¼šè¯å­˜å‚¨

### å‰ç«¯
- **React**: UIæ¡†æ¶
- **TypeScript**: ç±»å‹å®‰å…¨
- **Ant Design X**: UIç»„ä»¶
- **WebSocket**: å®æ—¶é€šä¿¡

### ç®¡ç†åå°
- **Vue 3**: UIæ¡†æ¶
- **Element Plus**: UIç»„ä»¶
- **TypeScript**: ç±»å‹å®‰å…¨
- **WebSocket**: å®æ—¶é€šä¿¡

## ğŸ“ˆ åç»­ä¼˜åŒ–

1. **æ€§èƒ½ä¼˜åŒ–**: WebSocketè¿æ¥æ± ç®¡ç†
2. **åŠŸèƒ½æ‰©å±•**: æ–‡ä»¶ä¼ è¾“ã€è¯­éŸ³æ¶ˆæ¯
3. **ç›‘æ§å‘Šè­¦**: æœåŠ¡çŠ¶æ€ç›‘æ§
4. **è´Ÿè½½å‡è¡¡**: å¤šå®ä¾‹éƒ¨ç½²
5. **å®‰å…¨åŠ å›º**: è®¤è¯å’Œæƒé™æ§åˆ¶
