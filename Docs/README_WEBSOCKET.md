# ğŸ”Œ WebSocket å®æ—¶é€šä¿¡å®ç°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç³»ç»Ÿä½¿ç”¨ WebSocket å®ç°å‰ç«¯ä¸åç«¯çš„å®æ—¶é€šä¿¡ï¼Œæ›¿ä»£ä¼ ç»Ÿçš„ HTTP è½®è¯¢æ–¹å¼ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ›´ä½çš„å»¶è¿Ÿã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
å‰ç«¯ (React + ProChat)
    â†•ï¸ WebSocket
æ¶ˆæ¯ç½‘å…³ (chat-core)
    â†•ï¸ HTTP API
AIæœåŠ¡ (ai-service) + ä¼šè¯æœåŠ¡ (chat-session)
```

## ğŸ”„ æ¶ˆæ¯æµç¨‹

### 1. è¿æ¥å»ºç«‹

```javascript
// å‰ç«¯è‡ªåŠ¨è¿æ¥
websocketService.connect(eventHandlers);
```

### 2. ä¼šè¯åˆå§‹åŒ–

```javascript
// ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶å‘é€initç±»å‹
{
  type: 'init',
  payload: {
    userId: 'generated-uuid',
    initialMessage: {
      text: 'ç”¨æˆ·çš„ç¬¬ä¸€æ¡æ¶ˆæ¯',
      type: 'text'
    }
  }
}
```

### 3. å¸¸è§„æ¶ˆæ¯

```javascript
// åç»­æ¶ˆæ¯å‘é€textç±»å‹
{
  type: 'text',
  text: 'ç”¨æˆ·æ¶ˆæ¯å†…å®¹',
  sessionId: 'session-uuid',
  userId: 'user-uuid'
}
```

### 4. AI å“åº”

```javascript
// æœåŠ¡å™¨è¿”å›AIå›å¤
{
  id: 'message-uuid',
  from: 'ai',
  text: 'AIå›å¤å†…å®¹',
  timestamp: '2025-06-10T16:30:00.000Z',
  sessionId: 'session-uuid'
}
```

## ğŸ“ å…³é”®æ–‡ä»¶

### å‰ç«¯ WebSocket æœåŠ¡

- **æ–‡ä»¶**: `chat-ui/src/services/websocketService.js`
- **åŠŸèƒ½**: ç®¡ç† WebSocket è¿æ¥ã€å‘é€/æ¥æ”¶æ¶ˆæ¯
- **æ–¹æ³•**:
  - `connect(eventHandlers)` - å»ºç«‹è¿æ¥
  - `sendMessage(messageObject)` - å‘é€æ¶ˆæ¯
  - `disconnect()` - æ–­å¼€è¿æ¥

### å‰ç«¯èŠå¤©å®¹å™¨

- **æ–‡ä»¶**: `chat-ui/src/components/Chat/ChatContainer.jsx`
- **åŠŸèƒ½**: ProChat ç»„ä»¶é›†æˆã€æ¶ˆæ¯çŠ¶æ€ç®¡ç†
- **ç‰¹æ€§**:
  - ç¦ç”¨ ProChat å†…ç½® HTTP è¯·æ±‚ (`request={false}`)
  - è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†é€»è¾‘
  - ä¼šè¯çŠ¶æ€æ˜¾ç¤º

### åç«¯ WebSocket æœåŠ¡å™¨

- **æ–‡ä»¶**: `chat-core/src/server/websocket.js`
- **åŠŸèƒ½**: WebSocket æœåŠ¡å™¨å®ç°ã€æ¶ˆæ¯è·¯ç”±
- **ç‰¹æ€§**:
  - è¿æ¥ç®¡ç†
  - æ¶ˆæ¯éªŒè¯
  - é”™è¯¯å¤„ç†

### æ¶ˆæ¯è·¯ç”±å™¨

- **æ–‡ä»¶**: `chat-core/src/services/MessageRouter.js`
- **åŠŸèƒ½**: æ¶ˆæ¯åˆ†å‘åˆ° AI æœåŠ¡æˆ–äººå·¥å®¢æœ
- **æµç¨‹**:
  1. æ¥æ”¶ WebSocket æ¶ˆæ¯
  2. åˆ›å»º/è·å–ä¼šè¯
  3. è°ƒç”¨ AI æœåŠ¡
  4. è¿”å›å“åº”

### æ¶ˆæ¯éªŒè¯

- **æ–‡ä»¶**: `chat-core/src/middleware/validation.js`
- **åŠŸèƒ½**: éªŒè¯ WebSocket æ¶ˆæ¯æ ¼å¼
- **æ”¯æŒç±»å‹**: `text`, `init`, `system`, `image`, `file`

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨ç³»ç»Ÿ

```bash
npm run dev
```

### è®¿é—®å‰ç«¯

```
http://localhost:5173
```

### å‘é€æ¶ˆæ¯

1. é¡µé¢åŠ è½½åè‡ªåŠ¨å»ºç«‹ WebSocket è¿æ¥
2. è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
3. ç³»ç»Ÿè‡ªåŠ¨å¤„ç†ä¼šè¯åˆå§‹åŒ–
4. AI æœåŠ¡è¿”å›æ™ºèƒ½å›å¤

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# WebSocketè¿æ¥åœ°å€
VITE_CHAT_CORE_WS_URL=ws://localhost:3001

# APIæœåŠ¡åœ°å€
VITE_CHAT_CORE_API_URL=http://localhost:3001/api
```

### ProChat é…ç½®ï¼ˆé‡è¦ï¼ï¼‰

```javascript
<ProChat
  messages={messages}
  onSend={handleSendMessage}
  // ğŸš¨ å…³é”®é…ç½®ï¼šå®Œå…¨æ‹¦æˆªå¹¶ç¦ç”¨ProChatçš„å†…ç½®HTTPè¯·æ±‚
  request={async () => {
    // è¿”å›ä¸€ä¸ªæ°¸è¿œä¸ä¼šresolveçš„Promiseï¼Œé˜»æ­¢ä»»ä½•HTTPè¯·æ±‚
    return new Promise(() => {});
  }}
  modelProvider="custom" // è‡ªå®šä¹‰æä¾›è€…
  config={{
    model: "custom",
    provider: "custom",
    baseURL: "", // è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²
    apiKey: "", // è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²
  }}
  // å¼ºåˆ¶ç¦ç”¨æ‰€æœ‰å†…ç½®è¯·æ±‚åŠŸèƒ½
  userMeta={{}}
  assistantMeta={{}}
  stream={false}
  autoSend={false}
/>
```

> âš ï¸ **é‡è¦æç¤º**ï¼šä»…è®¾ç½® `request={false}` ä¸è¶³ä»¥å®Œå…¨ç¦ç”¨ ProChat çš„ HTTP è¯·æ±‚ã€‚å¿…é¡»ä½¿ç”¨ä¸Šè¿°çš„ `request={async () => new Promise(() => {})}` æ–¹å¼æ¥å®Œå…¨æ‹¦æˆªè¯·æ±‚ã€‚

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **WebSocket è¿æ¥å¤±è´¥**

   - æ£€æŸ¥ chat-core æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ 3001 ç«¯å£
   - ç¡®è®¤é˜²ç«å¢™è®¾ç½®

2. **æ¶ˆæ¯å‘é€å¤±è´¥**

   - æ£€æŸ¥æ¶ˆæ¯æ ¼å¼æ˜¯å¦ç¬¦åˆéªŒè¯è§„åˆ™
   - ç¡®è®¤ WebSocket è¿æ¥çŠ¶æ€

3. **AI å›å¤é”™è¯¯**

   - æ£€æŸ¥ AI æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - ç¡®è®¤ API å¯†é’¥é…ç½®ï¼ˆæˆ–ä½¿ç”¨ demo æ¨¡å¼ï¼‰

4. **ProChat ä»ç„¶å‘é€ HTTP è¯·æ±‚**
   - ç°è±¡ï¼šæµè§ˆå™¨ç½‘ç»œé¢æ¿æ˜¾ç¤º `POST /api/openai/chat` è¯·æ±‚
   - åŸå› ï¼šProChat å†…ç½®çš„ HTTP è¯·æ±‚æœºåˆ¶æ²¡æœ‰å®Œå…¨ç¦ç”¨
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `request={async () => new Promise(() => {})}` å®Œå…¨æ‹¦æˆªè¯·æ±‚
   - éªŒè¯ï¼šæ£€æŸ¥ç½‘ç»œé¢æ¿åº”è¯¥ä¸å†æœ‰ HTTP è¯·æ±‚ï¼Œåªæœ‰ WebSocket è¿æ¥

### è°ƒè¯•æ–¹æ³•

1. **å‰ç«¯è°ƒè¯•**

   ```javascript
   // æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹WebSocketæ—¥å¿—
   console.log("WebSocketçŠ¶æ€:", websocketService.socket?.readyState);
   ```

2. **åç«¯è°ƒè¯•**
   ```bash
   # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
   npm run dev
   ```

## ğŸ“Š æ€§èƒ½ç‰¹ç‚¹

- âœ… **å®æ—¶é€šä¿¡**: æ¯«ç§’çº§æ¶ˆæ¯ä¼ é€’
- âœ… **ä½å»¶è¿Ÿ**: æ—  HTTP è½®è¯¢å¼€é”€
- âœ… **è‡ªåŠ¨é‡è¿**: è¿æ¥æ–­å¼€è‡ªåŠ¨æ¢å¤
- âœ… **æ¶ˆæ¯éªŒè¯**: ç¡®ä¿æ•°æ®å®Œæ•´æ€§
- âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

## ğŸ”„ æ‰©å±•åŠŸèƒ½

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

- `text` - æ–‡æœ¬æ¶ˆæ¯
- `init` - ä¼šè¯åˆå§‹åŒ–
- `system` - ç³»ç»Ÿæ¶ˆæ¯
- `image` - å›¾ç‰‡æ¶ˆæ¯ï¼ˆé¢„ç•™ï¼‰
- `file` - æ–‡ä»¶æ¶ˆæ¯ï¼ˆé¢„ç•™ï¼‰

### ä»£ç†åˆ‡æ¢

```javascript
// åˆ‡æ¢åˆ°äººå·¥å®¢æœ
handleSwitchAgent("human");

// åˆ‡æ¢å›AI
handleSwitchAgent("ai");
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v1.0.0** - åŸºç¡€ WebSocket å®ç°
- **v1.1.0** - æ·»åŠ æ¶ˆæ¯éªŒè¯å’Œé”™è¯¯å¤„ç†
- **v1.2.0** - æ”¯æŒä¼šè¯åˆå§‹åŒ–å’Œä»£ç†åˆ‡æ¢
- **v1.3.0** - é›†æˆ ProChat ç»„ä»¶ï¼Œç¦ç”¨ HTTP æ¨¡å¼
- **v1.4.0** - ä¿®å¤ ProChat HTTP è¯·æ±‚é—®é¢˜ï¼Œå®Œå…¨å®ç° WebSocket é€šä¿¡
- **v1.5.0** - ä¿®å¤ React ä¸¥æ ¼æ¨¡å¼é—®é¢˜ï¼Œä¼˜åŒ–è¿æ¥ç¨³å®šæ€§

## ğŸ¯ æµ‹è¯•éªŒè¯

### WebSocket åŠŸèƒ½æµ‹è¯•ç»“æœ

```
âœ… WebSocketè¿æ¥æˆåŠŸ
âœ… ä¼šè¯åˆå§‹åŒ–æ­£å¸¸ - æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯å’Œä¼šè¯ID
âœ… AIå›å¤æ­£å¸¸ - æ”¶åˆ°AIçš„æ™ºèƒ½å›å¤
âœ… å¤šè½®å¯¹è¯æ­£å¸¸ - å¯ä»¥è¿›è¡Œè¿ç»­å¯¹è¯
âœ… è¿æ¥ç®¡ç†æ­£å¸¸ - è‡ªåŠ¨é‡è¿å’Œé”™è¯¯å¤„ç†
```

### å‰ç«¯é›†æˆæµ‹è¯•ç»“æœ

```
âœ… ProChatç»„ä»¶æ­£å¸¸æ¸²æŸ“
âœ… WebSocketè¿æ¥çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
âœ… æ¶ˆæ¯å‘é€å’Œæ¥æ”¶æ­£å¸¸
âœ… ä¼šè¯çŠ¶æ€ç®¡ç†æ­£å¸¸
âœ… ä»£ç†åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
```

---

_æœ€åæ›´æ–°: 2025-06-11_
