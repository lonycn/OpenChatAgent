# ğŸ“¦ chat-session æ¨¡å—å¼€å‘ TODO

> **æ¨¡å—èŒè´£**ï¼šåŸºäº Redis çš„ä¼šè¯çŠ¶æ€ç®¡ç†ï¼Œç»´æŠ¤ç”¨æˆ·å¯¹è¯ä¸Šä¸‹æ–‡å’Œæ¥å¾…è€…çŠ¶æ€

## ğŸ¯ MVP æ ¸å¿ƒä»»åŠ¡ï¼ˆç¬¬ 1 å‘¨ï¼‰

### ğŸ”¥ P0 - åŸºç¡€ä¼šè¯ç®¡ç†

- [ ] **ç¯å¢ƒæ­å»º**

  - [ ] åˆ›å»º `chat-session/` ç›®å½•ç»“æ„
  - [ ] åˆå§‹åŒ– `package.json`ï¼Œå®‰è£…ä¾èµ– `ioredis`, `uuid`
  - [ ] é…ç½® Redis è¿æ¥å‚æ•°
  - [ ] åˆ›å»º Redis è¿æ¥æ± 

- [ ] **æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡**

  - [ ] è®¾è®¡ Redis Key å‘½åè§„èŒƒ
    - `session:{sessionId}:agent` - å½“å‰æ¥å¾…è€… (ai/human)
    - `session:{sessionId}:history` - æ¶ˆæ¯å†å²è®°å½•
    - `session:{sessionId}:meta` - ä¼šè¯å…ƒä¿¡æ¯
  - [ ] å®ç° `SessionManager` ç±»
  - [ ] å®ç°ä¼šè¯åˆ›å»ºå’Œåˆå§‹åŒ–

- [ ] **çŠ¶æ€ç®¡ç†æ ¸å¿ƒåŠŸèƒ½**
  - [ ] å®ç° `createSession(userId)` åˆ›å»ºæ–°ä¼šè¯
  - [ ] å®ç° `getSessionAgent(sessionId)` è·å–å½“å‰æ¥å¾…è€…
  - [ ] å®ç° `switchAgent(sessionId, agent)` åˆ‡æ¢æ¥å¾…è€…
  - [ ] å®ç° `addMessage(sessionId, message)` æ·»åŠ æ¶ˆæ¯è®°å½•

### ğŸŸ¡ P1 - æ¶ˆæ¯å†å²ç®¡ç†

- [ ] **æ¶ˆæ¯å­˜å‚¨**

  - [ ] å®ç°æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ– `{from, text, timestamp, type}`
  - [ ] å®ç° `getHistory(sessionId, limit)` è·å–å†å²æ¶ˆæ¯
  - [ ] å®ç°æ¶ˆæ¯åˆ†é¡µæŸ¥è¯¢åŠŸèƒ½
  - [ ] æ·»åŠ æ¶ˆæ¯ç±»å‹æ ‡è¯†ï¼ˆuser/ai/system/humanï¼‰

- [ ] **ä¼šè¯ç”Ÿå‘½å‘¨æœŸ**
  - [ ] å®ç°ä¼šè¯è¿‡æœŸæœºåˆ¶ï¼ˆ24 å°æ—¶è‡ªåŠ¨æ¸…ç†ï¼‰
  - [ ] å®ç° `isSessionActive(sessionId)` æ´»è·ƒçŠ¶æ€æ£€æŸ¥
  - [ ] å®ç° `extendSession(sessionId)` å»¶é•¿ä¼šè¯æ—¶é—´

## ğŸš€ æ‰©å±•åŠŸèƒ½ï¼ˆåç»­ç‰ˆæœ¬ï¼‰

### ğŸŸ¢ P2 - é«˜çº§åŠŸèƒ½

- [ ] **æ€§èƒ½ä¼˜åŒ–**

  - [ ] å®ç° Lua è„šæœ¬ä¼˜åŒ–æ‰¹é‡æ“ä½œ
  - [ ] æ·»åŠ æœ¬åœ°ç¼“å­˜å±‚å‡å°‘ Redis è®¿é—®
  - [ ] å®ç°æ¶ˆæ¯å†å²å‹ç¼©å­˜å‚¨

- [ ] **ç»Ÿè®¡åˆ†æ**
  - [ ] å®ç°ä¼šè¯ç»Ÿè®¡æ•°æ®æ”¶é›†
  - [ ] æ·»åŠ æ¥å¾…è€…åˆ‡æ¢è®°å½•
  - [ ] å®ç°ç”¨æˆ·æ´»è·ƒåº¦è¿½è¸ª

## ğŸ“ ç›®å½•ç»“æ„

```
chat-session/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ managers/
â”‚   â”‚   â”œâ”€â”€ SessionManager.js
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ Session.js
â”‚   â”‚   â””â”€â”€ Message.js
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ redis.js
â”‚   â”‚   â””â”€â”€ constants.js
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ session.test.js
â”‚   â””â”€â”€ redis.test.js
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ cleanup.lua
â””â”€â”€ package.json
```

## ğŸ”§ æŠ€æœ¯è¦æ±‚

- **è¯­è¨€**: Node.js (ES6+)
- **Redis å®¢æˆ·ç«¯**: ioredis
- **UUID ç”Ÿæˆ**: uuid
- **æµ‹è¯•æ¡†æ¶**: jest
- **æ•°æ®åºåˆ—åŒ–**: JSON

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

- [ ] èƒ½å¤ŸæˆåŠŸè¿æ¥ Redis å¹¶æ‰§è¡ŒåŸºæœ¬æ“ä½œ
- [ ] æ”¯æŒä¼šè¯çš„åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤
- [ ] æ”¯æŒæ¥å¾…è€…çŠ¶æ€çš„åŠ¨æ€åˆ‡æ¢
- [ ] æ”¯æŒæ¶ˆæ¯å†å²çš„å­˜å‚¨å’ŒæŸ¥è¯¢
- [ ] å…·å¤‡ä¼šè¯è¿‡æœŸè‡ªåŠ¨æ¸…ç†æœºåˆ¶
- [ ] é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•

## ğŸ”— ä¾èµ–å…³ç³»

- **è¢«ä¾èµ–**: `chat-core` æ¨¡å—è°ƒç”¨æœ¬æ¨¡å—
- **ä¾èµ–**: Redis æœåŠ¡
- **é…ç½®**: Redis è¿æ¥ä¿¡æ¯

## ğŸ“Š æ•°æ®æ¨¡å‹ç¤ºä¾‹

```javascript
// ä¼šè¯å…ƒä¿¡æ¯
{
  sessionId: "sess_123456",
  userId: "user_789",
  createdAt: "2024-01-01T00:00:00Z",
  lastActiveAt: "2024-01-01T01:00:00Z",
  status: "active"
}

// æ¶ˆæ¯è®°å½•
{
  id: "msg_001",
  from: "user", // user/ai/human/system
  text: "ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹äº§å“ä¿¡æ¯",
  timestamp: "2024-01-01T00:01:00Z",
  type: "text"
}
```
